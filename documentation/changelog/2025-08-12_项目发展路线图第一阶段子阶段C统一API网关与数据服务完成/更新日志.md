# 2025-08-12 统一 API 网关与数据服务（阶段 C）完成更新日志

## 背景
- 目标：以数据库为唯一数据源，提供统一 API 网关；逐步移除文件写入，保持前端零改动与契约不变。

## 变更概述（C-0 ~ C-7）
- C-0：冻结公开与管理接口契约，统一错误响应 envelope { error: { code, message } }。
- C-1：完成服务骨架与分层（路由/服务/持久化/中间件），Prisma Client 惰性加载，统一错误处理。
- C-2：公开接口 DB 优先 + 文件回退；完成映射层，确保键名/层级与现网一致。
- C-3：管理端读接口 DB 优先 + 文件回退。
- C-4：管理端写接口全面落库（事务），写成功后失效相关只读缓存键。
- C-5：发布机制切换为 status = draft|published；/api/admin/publish-all 改为 no-op（仅提示）。
- C-6：公开接口接入基础内存缓存与 ?refresh=true 手动刷新。
- C-7：自动化测试（公开/管理/鉴权）契约回归通过；可选写接口 E2E 在显式开启时执行。

## 影响范围
- 前端：零改动；继续调用既有 /api/* 接口，行为与契约不变。
- 后端：默认从 DB 读取；当 DB 不可用或客户端未生成时，公开/管理读接口回退到文件；写接口仅落库。

## 主要改动文件
- 文档
  - documentation/backend/api-contracts.md（契约样例、错误 envelope、发布接口弃用说明）
  - documentation/backend/field-mapping.md（DB → 前端字段映射细化）
  - documentation/backend/migration-notes.md（发布机制切换说明）
- 应用
  - lugarden_universal/application/src/routes/public.js（公开接口：DB 优先 + 回退 + 缓存 + refresh）
  - lugarden_universal/application/src/routes/admin.js（管理端读/写：DB 优先 + 回退/事务/缓存失效/鉴权）
  - lugarden_universal/application/src/services/mappers.js（映射适配）
  - lugarden_universal/application/src/persistence/prismaClient.js（Prisma 惰性加载）
  - lugarden_universal/application/src/middlewares/errorHandler.js（统一错误 envelope）
  - lugarden_universal/application/src/utils/cache.js（最小内存缓存与失效）
- 测试
  - lugarden_universal/application/tests/public-api.contract.test.js
  - lugarden_universal/application/tests/admin-api.contract.test.js
  - lugarden_universal/application/tests/admin-auth.contract.test.js

## 契约与兼容性
- 错误响应统一为 { error: { code, message } }。
- 公开接口 /api/projects 仅返回 status=published 的项目；其余接口键名与层级与现网保持一致。
- /api/admin/publish-all 已弃用（no-op），请使用 PUT /api/admin/projects/:projectId/status 切换发布状态。

## 测试与验收
- 契约测试：3 套件绿（公开 5 项、管理读 2 项、未鉴权 1 项）。
- 写接口 E2E：默认跳过；在 RUN_DB_WRITE_TESTS=1 下可执行完整创建/更新/删除/发布链路。
- 手动验证：?refresh=true 可强制刷新只读缓存；写操作后相关缓存键自动失效。

## 运维与回退
- 正常运行依赖本地 SQLite（lugarden.db）与 Prisma Client。
- 回退策略：若 DB 不可用，公开与管理读接口自动回退到文件；写接口仅落库（如失败返回错误）。

## 后续计划
- C-8：文档与收尾（本日志与清单）。
- C-9：端到端验证（两页核心路径无回归，异常为 0）。
