
# TODO 草稿：周与春秋数据治理 & 前端现代化迁移

> **目标**: 对已发布的"周与春秋"项目进行数据结构治理，实现一次"数据结构封版"。这旨在为后续引入Vue.js框架、提升项目可维护性奠定坚实、稳定的数据基础。
> **状态**: 讨论与规划中...

---

## **阶段A：需求分析与技术选型 (Discussion)**

### **A.0：技术基线评估：旁观者分析 (Completed Discussion)**
- **背景**: 在融入业务方（吴任几）的新需求前，从纯粹的技术视角对"周与春秋"现有数据结构进行一次健康检查。
- **目的**: 建立一个客观的技术基准，以便更科学地评估新需求的实现方案与成本。
- **结论**: 当前数据结构功能完备、逻辑自洽，但存在3个关键的优化机会点：
    1.  **文本字段实体化**: 将`ZhouPoem`中的`coreTheme`, `problemSolved`等文本标签字段，升级为独立的`Concept`实体和多对多关系，以增强查询能力和数据一致性。
    2.  **强化关系引用**: 将`ZhouMapping`中基于`poemTitle`文本的弱关联，升级为基于`poemId`外键的强关联，以避免因标题修改导致的数据关系断裂。
    3.  **数据去重**: 移除`ZhouQA`, `ZhouMapping`, `ZhouPoem`中重复的`chapter`字段，通过与`ZhouSubProject`的关系获取，确保篇章信息的单一数据源。
- **决策**: 这些纯技术优化建议将作为我们进行数据结构封版时的核心参考。

### **A.1：吴任几新需求澄清与数据模型决策 (Completed Discussion)**

#### **A.1.1: 恢复“用户原型”解读功能 (需求1)**
- **原始需求**: 在用户回答完问题后，先告诉用户其回答结果的“指代”，再展示诗歌。
- **深入分析**:
    - **核心识别**: 经讨论，此需求的核心是恢复在数据库迁移过程中被遗失的“用户原型”解读功能。
    - **数据考古**: 原始数据文件`questions.json`中的`results`结构内，`meaning`字段即为对答案组合的详细文字解读。
- **最终决策**:
    - **数据层**: 在`ZhouMapping`表中增加一个`meaning: String`字段。
    - **实施**: 编写一次性迁移脚本，从`questions.json`中读取并填充`meaning`数据。

#### **A.1.2: 结构化诗歌内容 (需求2)**
- **原始需求**: `classicalEcho`（古典回响）应同时展示“原文”和“解释”。
- **深入分析**:
    - **问题扩展**: 经深入讨论发现，不仅`classicalEcho`，诗歌的`body`字段本身也包含`引文`、`引文篇目`和`诗歌正文`三个结构化部分。
    - **语义辨析**: `body`中的引文是诗歌的**直接创作素材**，而`classicalEcho`是对`body`引文的**背景解释**。它们是两个独立但关联的概念。
    - **业务固化**: 确认“周与春秋”为已完成诗集，内容不会再扩展，因此数据模型应优先考虑**简洁性**而非未来的灵活性。
- **最终决策 (混合模型)**:
    - **`body`字段**: 将类型从`String`改为`Json`，用以封装诗歌的核心展示内容。其内部结构为：`{ "quote_text": "...", "quote_citation": "...", "main_text": "..." }`。
    - **`classicalEcho`字段**: **维持`String`类型不变**。它的功能被精确定义为：存储对`body.quote_text`的背景故事解释，不再进行JSON封装以保持简洁。
    - **实施**:
        1. 编写“演习”脚本，解析所有`ZhouPoem.body`的文本内容，生成一份包含`quote_text`, `quote_citation`, `main_text`三列的、可供人工验证的报告。
        2. 经您验证后，编写“写入”脚本，将`ZhouPoem.body`字段类型改为`Json`，并根据报告内容填充结构化数据。

### **A.2：前端框架技术选型 (Completed Discussion)**
- **讨论点**: 比较React与Vue在当前AI协作开发模式下的优劣。
- **已决策**: **选择Vue.js**。
- **决策理由**: Vue的单文件组件（SFC）结构更清晰、官方状态管理（Pinia）更统一，更适合AI进行稳定、高效、一致的代码生成，能显著降低我们之间的协作成本。

### **A.3：数据库迁移流程澄清 (Completed Discussion)**
- **讨论点**: 明确"数据迁移"在Prisma工作流中的含义。
- **已澄清**: "迁移"是管理数据库结构（Schema）演进的广义术语，是一个持续、版本化的过程。我们接下来的表结构调整将通过`prisma migrate dev`命令来规范地执行。

---

## **阶段B：数据结构封版 (Planning)**

### **B.1：数据库Schema变更设计 (Planning)**
- **任务**: 基于A.1的"数据需求"列表，设计具体的数据库`schema.prisma`变更。
- **内容**:
    - 确定需要在哪些表中增加新字段。
    - 确定新字段的类型、名称和约束（是否可选，有无默认值）。
    - 确定是否需要增加新的表或新的表间关系。
- **输出**: `schema.prisma`文件的更新草案。

### **B.2：执行数据库迁移 (Planning)**
- **任务**: 应用B.1中设计的Schema变更到数据库中。
- **步骤**:
    1.  备份当前数据库`lugarden.db`。
    2.  在`schema.prisma`中应用变更。
    3.  执行`npx prisma migrate dev --name "feature-zhou-data-governance"`生成并应用迁移。
    4.  重新生成Prisma Client。
- **验收标准**: 新的数据库结构生效，现有数据兼容，没有数据丢失。

### **B.3：API服务层适配 (Planning)**
- **任务**: 更新后端的API路由和服务，以支持新的数据结构。
- **内容**:
    - 修改`GET`请求，使其能够返回新增字段。
    - 修改`POST`/`PUT`请求，使其能够创建/更新包含新字段的数据。
    - 如有必要，创建新的API端点以支持新的数据关系。
- **验收标准**: 所有受影响的API端点功能正常，并通过自动化测试验证。

---

## **阶段C：前端现代化迁移 (High-level Planning)**

### **C.1：制定Vue迁移策略 (Planning)**
- **任务**: 规划从现有原生JavaScript代码到Vue.js组件的迁移路径。
- **待决策**:
    - **迁移范围**: 是完全重写`zhou.html`，还是采用渐进式迁移，先将部分功能组件化？
    - **状态管理**: 确定引入Pinia进行全局状态管理的具体方案。
    - **组件拆分**: 设计初步的组件层级结构（例如，`QuestionCard`, `ResultDisplay`, `PoemViewer`等）。

### **C.2：搭建Vue开发环境 (Planning)**
- **任务**: 在项目中集成Vue.js的开发环境。
- **步骤**:
    - 考虑使用Vite作为构建工具。
    - 在`lugarden_universal`目录下建立新的前端工程目录（如`frontend_vue`）。
    - 配置代理，使Vue开发服务器能与Express后端API通信。

### **C.3：实施前端迁移 (Planning)**
- **任务**: 根据C.1的策略，逐步将`zhou.html`的功能用Vue组件实现。
- **里程碑**:
    - 完成第一个核心组件的迁移（如问答卡片）。
    - 完成与后端API的数据对接和状态管理。
    - 完成整个页面的Vue化重构。
- **验收标准**: 新的Vue版本`zhou.html`在功能上完全对齐旧版本，且具备更好的可维护性和扩展性。

---
