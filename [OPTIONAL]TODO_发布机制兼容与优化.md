# 陆家花园 发布机制（草稿-更新-发布）兼容与优化 TODO

> **🤖 AI 助手注意 (AI Assistant Attention)**
> 在执行本文件中的任何任务前，你必须首先阅读并严格遵守位于 `documentation/ai-collaboration-guide.md` 的全局协作指南。

## 目标
在单一数据库（DB-only）模式下，记录原“草稿-更新-发布”机制部分失效的原因，并规划兼容与优化路线：确保后台编辑的“草稿态”与前台“已发布态”并行存在、可审核与可回滚，同时保持现有前端契约与用户体验稳定。

## 任务列表

> 任务编号规范
> - 第一阶段使用前缀“1”：任务1.1、任务1.2 …；步骤使用“1.1.x”的三级编号
> - 第二阶段使用前缀“2”：任务2.1、任务2.2 …；步骤使用“2.1.x”
> - 第三阶段使用前缀“3”：任务3.1、任务3.2 …；步骤使用“3.1.x”

### 第一阶段：现状记录与兼容
- [ ] 任务1.1：梳理现状与影响范围
  - 步骤1.1.1：总结“单库直写 + status 决定前台可见”的现状
  - 步骤1.1.2：明确“更新/发布全部”为兼容 no-op 的动机与影响
- [ ] 任务1.2：文案与UI处理
  - 步骤1.2.1：在 `admin.html` 弱化/标注“更新/发布全部”为兼容提示
  - 步骤1.2.2：强调“上架/下架”为唯一发布开关
- [ ] 任务1.3：合同与接口兼容
  - 步骤1.3.1：保留 `/api/admin/publish-all`、`/api/admin/projects/:id/update` 为 no-op
  - 步骤1.3.2：补充淘汰计划说明（文档）
- [ ] 任务1.4：健康检查与日志
  - 步骤1.4.1：在 `/api/health` 补充“发布模型：single-db, status-gated”标识
  - 步骤1.4.2：记录关键表计数与必要告警

### 第二阶段：方案评估与 PoC
- [ ] 任务2.1：备选方案评审
  - 步骤2.1.1：双库方案（staging/prod 跨库 promote）
  - 步骤2.1.2：单库双版本字段（draftContent/publishedContent + 原子 promote）
  - 步骤2.1.3：版本/修订表（revisions + published_revision_id）
- [ ] 任务2.2：数据模型与迁移草案
  - 步骤2.2.1：输出 ER 草图与迁移脚本草案
  - 步骤2.2.2：定义回滚路径与幂等策略
- [ ] 任务2.3：MVP 选择与 PoC 打样
  - 步骤2.3.1：评估复杂度/回滚需求/性能与成本
  - 步骤2.3.2：实现“编辑草稿→审核→发布（promote）→回滚（revert）”最小闭环
  - 步骤2.3.3：验证对外契约不变

### 第三阶段：落地与迁移
- [ ] 任务3.1：最终数据模型与迁移
  - 步骤3.1.1：应用 Prisma 迁移并验证安全/幂等
- [ ] 任务3.2：API 与权限流程落地
  - 步骤3.2.1：实现草稿写入、promote、revert API；只读接口契约保持不变
  - 步骤3.2.2：可选引入“发布权限/审核流”与操作审计
- [ ] 任务3.3：缓存一致性与监控
  - 步骤3.3.1：完善写后失效，promote/revert 后一致性保障
  - 步骤3.3.2：必要时加入 TTL/命中率日志
- [ ] 任务3.4：灰度切换与兼容端点下线
  - 步骤3.4.1：以 feature flag 灰度上线，监控稳定性
  - 步骤3.4.2：确认稳定后下线 no-op 兼容端点

## 更新日志关联
- **预计更新类型**: 项目治理/架构重构
- **更新目录**: `documentation/changelog/YYYY-MM-DD_发布机制兼容与优化/`
- **更新日志文件**: `更新日志.md`
- **测试验证点**: 
  - [ ] draft 项目在前台不可见，published 项目改动即时可见（契约不变）
  - [ ] 草稿编辑不影响已发布版本；promote 后前台读取新版本；revert 可回滚
  - [ ] 兼容端点仍返回提示且不破坏流程；新旧按钮共存期间无 4xx 回归

## 注意事项
- 每完成一个任务都要测试功能
- 如遇数据迁移/回滚风险，优先加护栏（事务/幂等与备份）
- 保持 Git 提交记录清晰（功能分支、原子提交、提交信息规范）

## 完成后的操作
- [ ] 创建更新目录：`documentation/changelog/YYYY-MM-DD_发布机制兼容与优化/`
- [ ] 将本TODO文件移动到更新目录并重命名为 `TODO.md`
- [ ] 创建对应的更新日志文档：`更新日志.md`
- [ ] 更新 `public/更新日志.md` 文件
- [ ] 提交所有更改到Git
- [ ] 更新项目状态

## 当前状态
🔄 进行中

---
*本模板基于陆家花园项目Git开发指南创建*


