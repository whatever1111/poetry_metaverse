<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试 - 陆家花园模块化架构</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #374151; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">陆家花园模块化架构测试</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- API测试区域 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">API测试</h2>
                <div class="space-y-4">
                    <button id="test-universes-api" class="btn btn-primary w-full">测试宇宙API</button>
                    <button id="test-projects-api" class="btn btn-primary w-full">测试项目API</button>
                    <button id="test-sub-projects-api" class="btn btn-primary w-full">测试子项目API</button>
                </div>
                <div id="api-results" class="mt-4 p-4 bg-gray-50 rounded text-sm"></div>
            </div>

            <!-- 功能测试区域 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">功能测试</h2>
                <div class="space-y-4">
                    <button id="test-module-loading" class="btn btn-success w-full">测试模块加载</button>
                    <button id="test-status-toggle" class="btn btn-success w-full">测试状态切换</button>
                    <button id="test-publish-all" class="btn btn-danger w-full">测试发布所有</button>
                </div>
                <div id="function-results" class="mt-4 p-4 bg-gray-50 rounded text-sm"></div>
            </div>
        </div>

        <!-- 测试结果展示 -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4">测试结果</h2>
            <div id="test-log" class="space-y-2 text-sm"></div>
        </div>
    </div>

    <script>
        // 测试工具类
        class TestRunner {
            constructor() {
                this.log = [];
                this.init();
            }

            init() {
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('test-universes-api').addEventListener('click', () => this.testUniversesAPI());
                document.getElementById('test-projects-api').addEventListener('click', () => this.testProjectsAPI());
                document.getElementById('test-sub-projects-api').addEventListener('click', () => this.testSubProjectsAPI());
                document.getElementById('test-module-loading').addEventListener('click', () => this.testModuleLoading());
                document.getElementById('test-status-toggle').addEventListener('click', () => this.testStatusToggle());
                document.getElementById('test-publish-all').addEventListener('click', () => this.testPublishAll());
            }

            async apiRequest(endpoint, method = 'GET', data = null) {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                };
                
                if (data && (method === 'POST' || method === 'PUT')) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(endpoint, options);
                const result = await response.text();
                
                return {
                    status: response.status,
                    ok: response.ok,
                    data: result
                };
            }

            logResult(title, result) {
                const timestamp = new Date().toLocaleTimeString();
                const status = result.ok ? '✅' : '❌';
                const logEntry = `[${timestamp}] ${status} ${title}: ${result.status} - ${result.data.substring(0, 200)}${result.data.length > 200 ? '...' : ''}`;
                
                this.log.push(logEntry);
                this.updateLogDisplay();
                
                return result;
            }

            updateLogDisplay() {
                const logElement = document.getElementById('test-log');
                logElement.innerHTML = this.log.map(entry => `<div class="p-2 bg-gray-50 rounded">${entry}</div>`).join('');
            }

            async testUniversesAPI() {
                this.logResult('宇宙API测试', await this.apiRequest('/api/admin/universes'));
            }

            async testProjectsAPI() {
                this.logResult('项目API测试', await this.apiRequest('/api/admin/projects'));
            }

            async testSubProjectsAPI() {
                // 先获取项目列表，然后测试第一个项目的子项目
                const projectsResult = await this.apiRequest('/api/admin/projects');
                if (projectsResult.ok) {
                    try {
                        const projects = JSON.parse(projectsResult.data);
                        if (projects.length > 0) {
                            const firstProject = projects[0];
                            const subResult = await this.apiRequest(`/api/admin/projects/${firstProject.id}/sub`);
                            this.logResult(`子项目API测试 (项目: ${firstProject.name})`, subResult);
                        } else {
                            this.logResult('子项目API测试', { ok: false, status: 404, data: '没有找到项目' });
                        }
                    } catch (e) {
                        this.logResult('子项目API测试', { ok: false, status: 500, data: '解析项目数据失败' });
                    }
                } else {
                    this.logResult('子项目API测试', projectsResult);
                }
            }

            async testModuleLoading() {
                try {
                    // 测试动态模块加载
                    const module = await import('./public/assets/universe-modules/zhou_spring_autumn.js');
                    this.logResult('模块加载测试', { ok: true, status: 200, data: '周与春秋模块加载成功' });
                } catch (error) {
                    this.logResult('模块加载测试', { ok: false, status: 500, data: `模块加载失败: ${error.message}` });
                }
            }

            async testStatusToggle() {
                // 测试状态切换API
                const projectsResult = await this.apiRequest('/api/admin/projects');
                if (projectsResult.ok) {
                    try {
                        const projects = JSON.parse(projectsResult.data);
                        if (projects.length > 0) {
                            const firstProject = projects[0];
                            const newStatus = firstProject.status === 'published' ? 'draft' : 'published';
                            const statusResult = await this.apiRequest(`/api/admin/projects/${firstProject.id}/status`, 'PUT', { status: newStatus });
                            this.logResult(`状态切换测试 (项目: ${firstProject.name}, 状态: ${newStatus})`, statusResult);
                        } else {
                            this.logResult('状态切换测试', { ok: false, status: 404, data: '没有找到项目' });
                        }
                    } catch (e) {
                        this.logResult('状态切换测试', { ok: false, status: 500, data: '解析项目数据失败' });
                    }
                } else {
                    this.logResult('状态切换测试', projectsResult);
                }
            }

            async testPublishAll() {
                // 测试发布所有更新API
                const result = await this.apiRequest('/api/admin/publish-all', 'POST');
                this.logResult('发布所有更新测试', result);
            }
        }

        // 初始化测试
        document.addEventListener('DOMContentLoaded', () => {
            new TestRunner();
        });
    </script>
</body>
</html>
